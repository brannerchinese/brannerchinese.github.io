<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>&</title>
	<meta name="description" content="">
	<meta name="author" content="David Prager Branner">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="http://brannerchinese.github.io/website/theme/html5.js"></script>
	<![endif]-->

	<!-- Styles -->
	<link href="http://brannerchinese.github.io/website/theme/bootstrap.min.css" rel="stylesheet">
	<link href="http://brannerchinese.github.io/website/theme/local.css" rel="stylesheet">
	<link href="http://brannerchinese.github.io/website/theme/pygments.css" rel="stylesheet">

    <!-- Feeds -->
    <link href="http://brannerchinese.github.io/website/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="& Atom Feed" />

</head>
<body>
	<div class="topbar">
	  <div class="topbar-inner">
		<div class="container-fluid">
		  <a class="brand" href="http://brannerchinese.github.io/website/">&</a>
			<ul class="nav">
					<li class="active"><a href="http://brannerchinese.github.io/website/category/.html"></a></li>
			</ul>
			<p class="pull-right"><a href="http://brannerchinese.github.io/website/archives.html">[archives]</a> <a href="http://brannerchinese.github.io/website/tags.html">[tags]</a></p>
		</div>
	  </div>
	</div>

	<div class="container-fluid">
	  <div class="sidebar">
		<div class="well">
			<h3>Blogroll</h3>
			<ul>
				<li><a href="https://brannerchinese.com/dpb/publications.html">Publications</a></li>
			</ul>
			<div class="social">
			<h3>Social</h3>
			<ul>
				<li><a href="feeds/all.atom.xml">RSS</a></li>
			</ul>
			</div>
		</div>
	  </div>
	  <div class="content">
	<div class='article'>
		<div class="page-header"><h1>Attempting a generic SQL INSERT statement in Python</h1></div>
		<div class="well small">Permalink: <a class="more" href="http://brannerchinese.github.io/website/attempting-a-generic-sql-insert-statement-in-python.html">2013-07-20 19:41:00</a>
by <a class="url fn" href="http://brannerchinese.github.io/website/author/david-prager-branner.html">David Prager Branner </a>
 in <a href="http://brannerchinese.github.io/website/category/.html"></a>
</div>
		<div><p>(The main version of this discussion is posted at <a href="https://github.com/brannerchinese/notes/blob/master/CONTENT/SQL/Attempting_a_generic_SQL_INSERT_statement_in_Python.md">my GitHub
notebook</a>, where it may be updated in future.)</p>
<hr />
<p>I am working with SQLite3 in Python but am not yet at the stage of using
an ORM such as SQLAlchemy. But I had the idea that I could save trouble
by writing a function to produce <code>INSERT</code> statements generically —
without having to write them out manually.</p>
<p>Below is what I came up with.</p>
<ul>
<li>An example of my original inline <code>INSERT</code> statements</li>
<li>The same insertion carried out by a generic function</li>
</ul>
<div class="highlight"><pre><span class="n">kanji_fields</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
        <span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;kanji_traditional&#39;</span><span class="p">,</span> <span class="n">kanji_traditional</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;kanji_simplified&#39;</span><span class="p">,</span> <span class="n">kanji_simplified</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;time_of_commit&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="p">))</span>
    <span class="n">insert</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="s">&#39;kanji&#39;</span><span class="p">,</span> <span class="n">kanji_fields</span><span class="p">)</span>
</pre></div>


<ul>
<li>The <code>insert()</code> function called above</li>
</ul>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CustomException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">field_ordereddict</span><span class="p">,</span> <span class="n">raise_error_or_not</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs and executes generic INSERT function.&quot;&quot;&quot;</span>

        <span class="n">the_string</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_ordereddict</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="c"># prepare replacement fields for SQL field names</span>
        <span class="n">the_string</span> <span class="o">=</span> <span class="s">&#39;{&#39;</span> <span class="o">+</span> <span class="s">&#39;},{&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">the_string</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;}&#39;</span>
        <span class="c"># prepare question marks for VALUES</span>
        <span class="n">question_marks</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="s">&#39;,?&#39;</span> \<span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_ordereddict</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># construct string</span>
        <span class="n">the_string</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;&#39;INSERT INTO {0} (&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">the_string</span> <span class="o">+</span> <span class="s">&#39;&#39;&#39;)</span>
<span class="s">                VALUES (&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">question_marks</span> <span class="o">+</span> <span class="s">&#39;&#39;&#39;)&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">the_string</span> <span class="o">=</span> <span class="n">the_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> 
                <span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">field_ordereddict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c"># execute as </span>
        <span class="c">#   cursor.execute(the_string, *tuple(field_ordereddict.values()))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">the_string</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">field_ordereddict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_error_or_not</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&#39;at {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">field_ordereddict</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
                <span class="k">raise</span> <span class="n">CustomException</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
</pre></div>


<h2>Notes on parameters:</h2>
<ul>
<li>
<p><code>cursor</code> is instantiated as:</p>
<div class="highlight"><pre><span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">with</span> <span class="n">con</span><span class="o">:</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
</pre></div>


</li>
</ul>
<p>and passed to this function.</p>
<ul>
<li><code>table_name</code> is the name of the table where <code>INSER</code>T is to take place</li>
<li><code>field_ordereddict</code> is a <code>collections.OrderedDict</code> of <code>(field_name, field_contents)</code> tuples. The <code>field_name</code> keys populate the arguments of the INTO expression and the field_contents values populate the arguments of the VALUES expression.
 • <code>raise_error_or_not</code> is used to decide whether or not to log details about a <code>sqlite3.IntegrityError</code> and then raise a <code>CustomException</code> or not.</li>
</ul>
<h2>Results</h2>
<ol>
<li><strong>Virtues</strong>. Chiefly modularity and readability. This design worked, and I was able to replace a number of long, messy in-line <code>INSERT</code> statements with neat <code>insert()</code> calls.</li>
<li><strong>Drawbacks</strong>. However, The time required increased by a factor of 3.2, which I judge fatal to my project.</li>
<li><strong>Going forward</strong>. Using <code>OrderedDict</code> to keep field-names and their contents organized improved readability:</li>
</ol>
<p>[end]</p></div>
		<div>
			<h2>Comments</h2>
		<div>
	</div>	
		<footer>
		  <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme based on <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.</p>
		  <p>&copy; David Prager Branner</p>
		</footer>
	  </div>

	</div>
</body>
</html>